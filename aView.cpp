// aView.cpp : implementation of the CAView class
//

#include "stdafx.h"
#include "a.h"

#include "aDoc.h"
#include "aView.h"
#include"suanfa.h"
#include "MainFrm.h"
#include "math.h"
#define RADIAN(angle) ((angle)*PI/180.0)
#define PI 2*asin(1)
#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif

/////////////////////////////////////////////////////////////////////////////
// CAView

IMPLEMENT_DYNCREATE(CAView, CView)

BEGIN_MESSAGE_MAP(CAView, CView)
	//{{AFX_MSG_MAP(CAView)
	ON_WM_ERASEBKGND()
	ON_UPDATE_COMMAND_UI(ID_EDIT_UNDO, OnUpdateEditUndo)
	ON_WM_MOUSEMOVE()
	ON_COMMAND(ID_EDIT_UNDO, OnEditUndo)
	ON_COMMAND(ID_LINE_CHANGE, OnLinetrans)
	ON_COMMAND(ID_THRESHOLD, OnThreshold)
	ON_COMMAND(ID_Ljinterpolationzoom, OnLjinterpolationzoom)
	ON_COMMAND(ID_LjInterpolaRotate, OnLjInterpolaRotate)
	ON_COMMAND(ID_OnSInterpolaZoom, OnSInterpolaZoom)
	ON_COMMAND(ID_OnSInterpolaRotate, OnSInterpolaRotate)
	ON_COMMAND(ID_ENhanSmooth, OnENhanSmooth)
	ON_COMMAND(ID_MedianFilter, OnMedianFilter)
	ON_COMMAND(ID_EnhaGradsharp, OnEnhaLsharp)
	ON_COMMAND(ID_Erosion, OnMorphErosion)
	ON_COMMAND(ID_OnDilation, OnMorphDilation)
	ON_COMMAND(ID_liantong, Onliantong)
	ON_COMMAND(ID_LianTongPhone, OnLianTongPhone)
	//}}AFX_MSG_MAP
	// Standard printing commands
	ON_COMMAND(ID_FILE_PRINT, CView::OnFilePrint)
	ON_COMMAND(ID_FILE_PRINT_DIRECT, CView::OnFilePrint)
	ON_COMMAND(ID_FILE_PRINT_PREVIEW, CView::OnFilePrintPreview)
END_MESSAGE_MAP()

/////////////////////////////////////////////////////////////////////////////
// CAView construction/destruction

CAView::CAView()
{
	// TODO: add construction code here
	HRedo[0]= HRedo[1]=HRedo[2]=NULL;
}

CAView::~CAView()
{
		for(int i=0;i<3;i++)
		if(HRedo[i]!=NULL)                                      
			::GlobalFree((HGLOBAL)HRedo[i]);
		
		HRedo[0]= HRedo[1]=HRedo[2]=NULL;
		 
		
}

BOOL CAView::PreCreateWindow(CREATESTRUCT& cs)
{
	// TODO: Modify the Window class or styles here by modifying
	//  the CREATESTRUCT cs

	return CView::PreCreateWindow(cs);
}

/////////////////////////////////////////////////////////////////////////////
// CAView drawing

void CAView::OnDraw(CDC* pDC)
{
	// ?????????
	BeginWaitCursor();
	
	// ??????
	CADoc* pDoc = GetDocument();
	ASSERT_VALID(pDoc);
	
	// ???DIB
	HDIB hDIB = pDoc->GetHDIB();
	
	// ?ж?DIB??????
	if (hDIB != NULL)
	{
		LPSTR lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) hDIB);
		
		// ???DIB????
		int cxDIB = (int) ::DIBWidth(lpDIB);
		
		// ???DIB???
		int cyDIB = (int) ::DIBHeight(lpDIB);

		::GlobalUnlock((HGLOBAL) hDIB);
		
		CRect rcDIB;
		rcDIB.top = rcDIB.left =0;
		rcDIB.right = cxDIB;
		rcDIB.bottom = cyDIB;
		
		CRect rcDest;
	    
		rcDest = rcDIB;
		
		// ???DIB
		::PaintDIB(pDC->m_hDC, &rcDest, pDoc->GetHDIB(),&rcDIB, pDoc->GetDocPalette());
	}
	
	// ??????????
	EndWaitCursor();
}

/////////////////////////////////////////////////////////////////////////////
// CAView printing

BOOL CAView::OnPreparePrinting(CPrintInfo* pInfo)
{
	// default preparation
	return DoPreparePrinting(pInfo);
}

void CAView::OnBeginPrinting(CDC* /*pDC*/, CPrintInfo* /*pInfo*/)
{
	// TODO: add extra initialization before printing
}

void CAView::OnEndPrinting(CDC* /*pDC*/, CPrintInfo* /*pInfo*/)
{
	// TODO: add cleanup after printing
}

/////////////////////////////////////////////////////////////////////////////
// CAView diagnostics

#ifdef _DEBUG
void CAView::AssertValid() const
{
	CView::AssertValid();
}

void CAView::Dump(CDumpContext& dc) const
{
	CView::Dump(dc);
}

CADoc* CAView::GetDocument() // non-debug version is inline
{
	ASSERT(m_pDocument->IsKindOf(RUNTIME_CLASS(CADoc)));
	return (CADoc*)m_pDocument;
}
#endif //_DEBUG

/////////////////////////////////////////////////////////////////////////////
// CAView message handlers

LRESULT CAView::OnDoRealize(WPARAM wParam, LPARAM)
{
	ASSERT(wParam != NULL);
	
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ?ж?DIB??????
	if (pDoc->GetHDIB() == NULL)
	{
		// ??????
		return 0L;
	}
	
	// ???Palette
	CPalette* pPal = pDoc->GetDocPalette();
	
	if (pPal != NULL)
	{
		// ???MainFrame
		CMainFrame* pAppFrame = (CMainFrame*) AfxGetApp()->m_pMainWnd;
		ASSERT_KINDOF(CMainFrame, pAppFrame);
		
		CClientDC appDC(pAppFrame);
		
		// All views but one should be a background palette.
		// wParam contains a handle to the active view, so the SelectPalette
		// bForceBackground flag is FALSE only if wParam == m_hWnd (this view)
		CPalette* oldPalette = appDC.SelectPalette(pPal, ((HWND)wParam) != m_hWnd);
		
		if (oldPalette != NULL)
		{
			UINT nColorsChanged = appDC.RealizePalette();
			if (nColorsChanged > 0)
				pDoc->UpdateAllViews(NULL);
			appDC.SelectPalette(oldPalette, TRUE);
		}
		else
		{
			TRACE0("\tCCh1_1View::OnPaletteChanged?е???SelectPalette()????\n");
		}
	}
	
	return 0L;
}

BOOL CAView::OnEraseBkgnd(CDC* pDC) 
{

		// ?????????????????????????
	// ?????????????????m_refColorBKG???
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???????Brush
	CBrush brush(pDoc->m_refColorBKG);                                              
	
	// ?????????Brush
	CBrush* pOldBrush = pDC->SelectObject(&brush);
	
	// ??????????
	CRect rectClip;
	pDC->GetClipBox(&rectClip);
	
	// ???
	pDC->PatBlt(rectClip.left, rectClip.top, rectClip.Width(), rectClip.Height(), PATCOPY);
	
	// ????????Brush
	pDC->SelectObject(pOldBrush);                                                  
	
	// ????
	return TRUE;
	
}



void CAView::Undo()
{
if (HRedo[0]==NULL && HRedo[1]==NULL && HRedo[2]==NULL)
		return;
	
	CADoc* pDoc = GetDocument();
	
	if ((pDoc->GetHDIB())!= NULL)
	{
		// ?????????
		::GlobalFree((HGLOBAL)(pDoc->GetHDIB()));
	}
	
	if(HRedo[2]!=NULL)
	{
		pDoc->ReplaceHDIB((HDIB)HRedo[2]);
		HRedo[2]=NULL;	
	}
	else
	{ 
		if(HRedo[1]!=NULL)
		{  
			pDoc->ReplaceHDIB((HDIB)HRedo[1]);
			HRedo[1]=NULL;	
		}
        else
		{
			pDoc->ReplaceHDIB((HDIB)HRedo[0]);
			HRedo[0]=NULL;	
		}
	}
	
	// ????DIB??С??????
	pDoc->InitDIBData();
	
	// ???????ù????????С
//	SetScrollSizes(MM_TEXT, pDoc->GetDocSize());
	
	// ????μ?????
	OnDoRealize((WPARAM)m_hWnd,0);
	
	// ???????
	pDoc->UpdateAllViews(NULL);
}

void CAView::OnUpdateEditUndo(CCmdUI* pCmdUI) 
{
	// TODO: Add your command update UI handler code here
	pCmdUI->Enable(HRedo[0]!=NULL);
}

void CAView::BackForUndo(HGLOBAL h)
{
	if (HRedo[0]!=NULL && HRedo[1]!=NULL && HRedo[2]!=NULL)
	{    
		::GlobalFree((HGLOBAL)HRedo[0]);
		HRedo[0]=HRedo[1];
		HRedo[1]=HRedo[2];
		HRedo[2]=::CopyHandle(h);
		return ;
	}
	
	
	if (HRedo[0]==NULL)
		HRedo[0]=::CopyHandle(h);
	else
	{  
		if (HRedo[1]==NULL)
            HRedo[1]=::CopyHandle(h);
		else
            HRedo[2]=::CopyHandle(h);
	}
}

void CAView::OnMouseMove(UINT nFlags, CPoint point) 
{
	CString str;
	CMainFrame* pFrame = (CMainFrame*) AfxGetApp()->m_pMainWnd;
	CStatusBar* pStatus = &pFrame->m_wndStatusBar;
	if (pStatus) {
		str.Format("x = %d", point.x);
		pStatus->SetPaneText(0, str);
		str.Format("y = %d", point.y);
		pStatus->SetPaneText(1, str);
	}
}

void CAView::OnEditUndo() 
{
	// TODO: Add your command handler code here
	Undo();
}

void CAView::OnLinetrans() 
{
 // ????任 

	 BackForUndo(GetDocument()->GetHDIB());	
	//??????
	CADoc*pDoc=GetDocument();
	//??? DIB?????
	LPSTR lpDIB;
	//???DIB???????
	LPBYTE lpDIBBits;
	 //????DIB 
	 lpDIB=(LPSTR)::GlobalLock((HGLOBAL)pDoc->GetHDIB());


	 lpDIBBits=(LPBYTE)::FindDIBBits(lpDIB);//??????????
  
    BeginWaitCursor();
    //????
     Linertrans(lpDIBBits,::DIBWidth(lpDIB),::DIBHeight(lpDIB));
    //????
     pDoc->SetModifiedFlag(TRUE);
	 pDoc->UpdateAllViews (NULL);//????
	 
	 ::GlobalUnlock((HGLOBAL)pDoc->GetHDIB());//????DIB
      EndWaitCursor();
}

BOOL CAView::Linertrans(LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{
  // ????任

    /* ???:lpDIBBits?????????????????????
            lWidth????????
            lHeight???????
    */

    /**********??????????p??????***************************************/
	LPBYTE lpSrc,lpDst;//???????
	LONG lLineBytes;//????????
	lLineBytes=WIDTHBYTES(lWidth *8);
    long i,j;	// ???????
   
	float a=5;//????任б??
	float b=12;//????任???
  
	/******************************????????д??**********************************/

    DOUBLE fTemp;

	for(i=0;i<lHeight;i++)
	{
		for(j=0;j<lWidth;j++)
		{
			if((i+j)%4==0)
				lpDIBBits[i*lWidth+j]=255;
		}
	}
/*	for(i=0;i<lHeight;i++)
	{
		for(j=0;j<lWidth;j++)
		{
            lpSrc=lpDIBBits+lLineBytes*i+j;
		 	fTemp=a*(*lpSrc)+b;
			if(fTemp>255)
			{
			*lpSrc=255;
			}
			else if(fTemp<0)
			{
			*lpSrc=0;
			}
			else
			{
		    *lpSrc=(unsigned char)(fTemp+0.5);
			}
			
		}
	}*/

   /*******************************************************************************/
	return  TRUE;
}

void CAView::OnThreshold() 
{
	//??????
	
    BackForUndo(GetDocument()->GetHDIB());	
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR	lpDIB;

	// ???DIB???????
	LPBYTE   lpDIBBits;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	// ?????????
	BeginWaitCursor();

	// ???DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);
	
	// ????ThresholdDIB()??????DIB??????????
	if (ThresholdDIB(lpDIBBits,::DIBWidth(lpDIB), ::DIBHeight(lpDIB)))
	{
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);

		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????", "?????" , MB_ICONINFORMATION | MB_OK);
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();
	
}

BOOL CAView::ThresholdDIB(LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{

    //?????? 

    /* ???:lpDIBBits?????????????????????
            lWidth????????
            lHeight???????
    */
  /**********??????????p??????***************************************/
	
	LPBYTE lpSrc;//???????
	LONG lLineBytes;//????????
	lLineBytes=WIDTHBYTES(lWidth *8);
    long i,j;	// ???????
    float num=100;//????
	
  /****************************?????????д????????*************/

 
	
	for(i=0;i<lWidth;i++){
	
	      for(j=0;j<lHeight;j++)
		  {
		     lpSrc=lpDIBBits+lLineBytes*j+i;
		
		     if(*lpSrc>=100)
			 {
			    *lpSrc=(unsigned char)255;
			 }
		     else
			 {
			     *lpSrc=(unsigned char)0;
			 }
		  }

	}
	
	
	
	return TRUE;
    
}

void CAView::OnLjinterpolationzoom() 
{
BackForUndo(GetDocument()->GetHDIB());
// ?????

	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
    // ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;
	
	// ????DIB??????????λ??
	lpDIBBits =(LPBYTE)::FindDIBBits(lpDIB);

	// ??????
	float ZoomRatio=5.0;



	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ????ZoomDIB()???????DIB
	hNewDIB = (HDIB)LjInterpolaZoom (lpDIB,lpDIBBits, lWidth, lHeight ,ZoomRatio );
	
	// ?ж??????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
		
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();

	
}
	




HGLOBAL CAView::LjInterpolaZoom(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight, FLOAT ZoomRatio)
{
 /*// ???????????
	LPSTR	lpDIB;
	
	
	// ??????????????λ??????
    LPBYTE	lpDIBBits;
	
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
	
   // ?????
	FLOAT ZoomRatio  ;*/


	// ???????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
		
	// ?????????????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;
    // ???????DIB???
	HDIB	hDIB;

	// ????????????
	LONG	lNewLineBytes;
/***************************/

/** ??д: ????????μ??????????  **/
	
	// ????????????
	LPBYTE	lpSrc;
	
	// ????????????????????
	LPBYTE	lpDst;
	
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	// ???????DIB?е?????
	LONG	i0;
	LONG	j0;
	
	// ?????е??????
	LONG lLineBytes;
	
		// ?????????е??????
	lLineBytes = WIDTHBYTES(lWidth * 8);
	
	
	// ???????????????????
	lNewWidth = (LONG) (lWidth * ZoomRatio + 0.5);
	
	// ???????????е??????
	lNewLineBytes = WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) (lHeight * ZoomRatio + 0.5);
	


/****************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (char * )::GlobalLock((HGLOBAL) hDIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits = (LPBYTE)::FindDIBBits(lpNewDIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	
	// ????DIB????????????
	

		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;

/****************************/
/*??д:???????????????????????????
       ????ж????????????,????л?????0??255*/
		for(i = 0; i < lNewWidth; i++){
			for(j = 0; j < lNewHeight; j++){
				lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 - i) + j;

				i0 = (LONG) (i / ZoomRatio + 0.5);
				j0 = (LONG) (j / ZoomRatio + 0.5);

				if((j0 >= 0) && (j0 < lWidth) && (i0 >= 0) && (i0 < lHeight))
				{
					lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 - i0) + j0;
					*lpDst = *lpSrc;
				}else
				{
					*((unsigned char*)lpDst) = 255;
				}

			}
		}
	
	
	
	
/****************************/

return hDIB;

}

void CAView::OnLjInterpolaRotate() 
{
BackForUndo(GetDocument()->GetHDIB());	
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;

	
	// ????DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);
	
	// ??????
   FLOAT RotateAngle=(float)3.14/10;
	    
	
	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ?????????????????
	hNewDIB = (HDIB)LjInterpolaRotate (lpDIB,lpDIBBits ,lWidth,lHeight,RotateAngle);
	
	// ?ж?????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
	
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("??????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();

}

HGLOBAL CAView::LjInterpolaRotate(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight, FLOAT RotateAngle)
{
  /* ???????????
	LPSTR	lpDIB;
	
	
	// ??????????????λ??????
	LPBYTE	lpDIBBits;
	
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
	
   // ??????
	FLOAT  RotateAngle ;  */

  // ????????????lNewWidth'????????4???????
	LONG	lLineBytes=WIDTHBYTES(lWidth * 8);
	

	// ???????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
	
	// ?????????????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;   
    // ???????DIB???
	HDIB	hDIB;
	 

/***************************/

/** ??д:  ??????????????????μ??????????  **/
    
	// ????????????
	LPBYTE	lpSrc;
	
		
	// ???????????????????
	LPBYTE	lpDst;
	
		
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	// ???????DIB?е?????
	LONG	i0;
	LONG	j0;
	
	
	// ????????????????
	float	fSina, fCosa;
	
	// ??????????????????????????????
	float	fSrcX1,fSrcY1,fSrcX2,fSrcY2,fSrcX3,fSrcY3,fSrcX4,fSrcY4;
	
	// ?????????????????????????????????
	float	fDstX1,fDstY1,fDstX2,fDstY2,fDstX3,fDstY3,fDstX4,fDstY4;
	
	// ?????м???
	float	f1,f2;

	// ???????????????
	fSina = (float) sin((float)RotateAngle);
	
	// ???????????????
	fCosa = (float) cos((float)RotateAngle);
	
	// ????????????????????????????????????
	fSrcX1 = (float) (- (lWidth  - 1) / 2);
	fSrcY1 = (float) (  (lHeight - 1) / 2);
	fSrcX2 = (float) (  (lWidth  - 1) / 2);
	fSrcY2 = (float) (  (lHeight - 1) / 2);
	fSrcX3 = (float) (- (lWidth  - 1) / 2);
	fSrcY3 = (float) (- (lHeight - 1) / 2);
	fSrcX4 = (float) (  (lWidth  - 1) / 2);
	fSrcY4 = (float) (- (lHeight - 1) / 2);
	
	// ???????????????????????????????????
	fDstX1 =  fCosa * fSrcX1 + fSina * fSrcY1;
	fDstY1 = -fSina * fSrcX1 + fCosa * fSrcY1;
	fDstX2 =  fCosa * fSrcX2 + fSina * fSrcY2;
	fDstY2 = -fSina * fSrcX2 + fCosa * fSrcY2;
	fDstX3 =  fCosa * fSrcX3 + fSina * fSrcY3;
	fDstY3 = -fSina * fSrcX3 + fCosa * fSrcY3;
	fDstX4 =  fCosa * fSrcX4 + fSina * fSrcY4;
	fDstY4 = -fSina * fSrcX4 + fCosa * fSrcY4;
	
	// ???????????????????
	lNewWidth  = (LONG) ( max( fabs(fDstX4 - fDstX1), fabs(fDstX3 - fDstX2) ) + 0.5);
	
	
	// ?????????????lNewWidth'????????4???????
	LONG	lNewLineBytes=WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) ( max( fabs(fDstY4 - fDstY1), fabs(fDstY3 - fDstY2) )  + 0.5);
	
	// ???????????????????????ζ???????
	//????????????????????????????????????????????????????
	f1 = (float) (-0.5 * (lNewWidth - 1) * fCosa - 0.5 * (lNewHeight - 1) * fSina
		+ 0.5 * (lWidth  - 1));
	f2 = (float) ( 0.5 * (lNewWidth - 1) * fSina - 0.5 * (lNewHeight - 1) * fCosa
		+ 0.5 * (lHeight - 1));

		
/*******************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (LPSTR)::GlobalLock((HGLOBAL) hDIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits = (LPBYTE)::FindDIBBits(lpNewDIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	
	// ????DIB????????????
	

		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;

/****************************/
/*??д:???????????????????????????
       ????ж????????????,????л?????0??255*/

	for(i=0;i<lNewHeight;i++)
	{
		for(j=0;j<lNewWidth;j++)
		{
			lpDst=lpNewDIBBits+lNewLineBytes*(lNewHeight-1-i)+j;

			i0=(LONG)(-((float)j)*fSina+((float)i)*fCosa+f2+0.5);
			j0=(LONG)(((float) j)*fCosa+((float) i )*fSina+f1+0.5);

			if((j0>=0)&&(j0<lWidth)&&(i0>=0)&&(i0<lHeight))
			{
				lpSrc=lpDIBBits+lLineBytes*(lHeight-1-i0)+j0;

				*lpDst=*lpSrc;
			}
			else{
				*((unsigned char *)lpDst)=255;
			}
		}
	}

/****************************/

return hDIB;

}

void CAView::OnSInterpolaZoom() 
{BackForUndo(GetDocument()->GetHDIB());
   // ?????

	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
    // ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;
	
	// ????DIB??????????λ??
	lpDIBBits =( LPBYTE)::FindDIBBits(lpDIB);

	// ??????
	float ZoomRatio=5.0;



	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ????ZoomDIB()???????DIB
	hNewDIB = (HDIB)SInterpolaZoom (lpDIB,lpDIBBits, lWidth, lHeight ,ZoomRatio );
	
	// ?ж??????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
	
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();

	
	



	
}

HGLOBAL CAView::SInterpolaZoom(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight, FLOAT ZoomRatio)
{
 /* // ???????????
	LPSTR	lpDIB;

	// ??????????????λ??????
	LPBYTE	lpDIBBits;
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
	
   // ?????
	FLOAT ZoomRatio  ;*/

	// ???????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
		
	// ?????????????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;
    // ???????DIB???
	HDIB	hDIB;

	// ????????????
	LONG	lNewLineBytes;
/***************************/

/** ??д: ????????μ??????????  **/

	// ????????????????????
	LPBYTE	lpDst;
	
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	// ???????DIB?е?????
	float	i0;
	float	j0;
	
	// ?????е??????
	LONG lLineBytes;
	
		// ?????????е??????
	lLineBytes = WIDTHBYTES(lWidth * 8);
	
	
	// ???????????????????
		lNewWidth = (LONG) (lWidth * ZoomRatio + 0.5);
	
	// ???????????е??????
	lNewLineBytes = WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) (lHeight * ZoomRatio + 0.5);
	

/****************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (char * )::GlobalLock((HGLOBAL) hDIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits =(LPBYTE) ::FindDIBBits(lpNewDIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	
	// ????DIB????????????
	
		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;




	// ?????????????????(i1, j1), (i2, j1), (i1, j2), (i2, j2)
	LONG	i1, i2;
	LONG	j1, j2;
	
	// ?????????????
	unsigned char	f1, f2, f3, f4;
	
	// ????????м??

	unsigned char	f12, f34;
	
	// ???????????????????????С????????????????????????????
	FLOAT	EXP;

		// ???
	EXP = (FLOAT) 0.0001;

/////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
/////////////****************************/
/*??д:??????????????????????????
       ????ж????????????,????л?????0??255*/

	for(i = 0; i < lNewHeight; i++){
		for(j = 0; j < lNewWidth; j++) {
			lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -i) +j;

			i0 = (float)i / ZoomRatio;
			j0 = (float)j / ZoomRatio;
			i1 = (LONG) i0;
			i2 = i1 + 1;
			j1 = (LONG) j0;
			j2 = j1 + 1;

			if((j0 < 0) || (j0 > lWidth - 1) || (i0 < 0) || (i0 > lHeight - 1)){
				*lpDst = (unsigned char) 255;
			}else{
				if(fabs(j0 - lWidth + 1) <= EXP) {
					if(fabs(i0 - lHeight + 1) <= EXP) {
						f1 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i1) + j1);
						*lpDst = (unsigned char) f1;
					} else {
						f1 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i1) + j1);
						f3 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i2) + j2);
						*lpDst = (unsigned char) (f1 + (i0 - i1) * (f3 - f1));
					}
				}else if(fabs(i0 - lHeight + 1) <= EXP) {
					f1 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i1) + j1);
					f1 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i2) + j2);
						*lpDst = (unsigned char) (f1 + (j0 - j1) * (f2 - f1));
				}else {
					f1 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i1) + j1);
					f2 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i1) + j2);
					f3 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i2) + j1);
					f4 = *(lpDIBBits + lLineBytes * (lHeight - 1 -i2) + j2);

					f12 = (unsigned char) (f1 + (j0 - j1) * (f2 -f1));
					f34 = (unsigned char) (f3 + (j0 - j1) * (f4 -f3));
					*lpDst = (unsigned char) (f12 + (i0 - i1) * (f34 -f12));
				}
			}
			
		}
	}
	

/****************************/

return hDIB;


}

void CAView::OnSInterpolaRotate() 
{
BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;


	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);
	
	// ??????
    FLOAT RotateAngle=(float)3.1415/10;
	

	
	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ??????????????????
	hNewDIB = (HDIB)SInterpolaRotate (lpDIB,lpDIBBits ,lWidth,lHeight,RotateAngle);
	
	// ?ж?????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
			
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();
		
}





HGLOBAL CAView::SInterpolaRotate(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight, FLOAT RotateAngle)
{

/* // ???????????
	LPSTR	lpDIB;
	
	
	// ??????????????λ??????
	LPBYTE	lpDIBBits;
	
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
	
   // ??????
	FLOAT  RotateAngle ;*/

   // ????????????lNewWidth'????????4???????
	LONG	lLineBytes=WIDTHBYTES(lWidth * 8);
	

	// ???????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
		
	// ?????????????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;
    // ???????DIB???
	HDIB	hDIB;

	
/***************************/

/** ??д:  ??????????????????μ??????????  **/
  
   		
	// ???????????????????
	LPBYTE	lpDst;
	
		
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	// ???????DIB?е?????
	float	i0;
	float	j0;
	
	
	// ????????????????
	float	fSina, fCosa;
	
	// ??????????????????????????????
	float	fSrcX1,fSrcY1,fSrcX2,fSrcY2,fSrcX3,fSrcY3,fSrcX4,fSrcY4;
	
	// ?????????????????????????????????
	float	fDstX1,fDstY1,fDstX2,fDstY2,fDstX3,fDstY3,fDstX4,fDstY4;
	
	// ?????м???
	float	f11,f22;

	// ???????????????
	fSina = (float) sin((float)RotateAngle);
	
	// ???????????????
	fCosa = (float) cos((float)RotateAngle);
	
	// ????????????????????????????????????
	fSrcX1 = (float) (- (lWidth  - 1) / 2);
	fSrcY1 = (float) (  (lHeight - 1) / 2);
	fSrcX2 = (float) (  (lWidth  - 1) / 2);
	fSrcY2 = (float) (  (lHeight - 1) / 2);
	fSrcX3 = (float) (- (lWidth  - 1) / 2);
	fSrcY3 = (float) (- (lHeight - 1) / 2);
	fSrcX4 = (float) (  (lWidth  - 1) / 2);
	fSrcY4 = (float) (- (lHeight - 1) / 2);
	
	// ???????????????????????????????????
	fDstX1 =  fCosa * fSrcX1 + fSina * fSrcY1;
	fDstY1 = -fSina * fSrcX1 + fCosa * fSrcY1;
	fDstX2 =  fCosa * fSrcX2 + fSina * fSrcY2;
	fDstY2 = -fSina * fSrcX2 + fCosa * fSrcY2;
	fDstX3 =  fCosa * fSrcX3 + fSina * fSrcY3;
	fDstY3 = -fSina * fSrcX3 + fCosa * fSrcY3;
	fDstX4 =  fCosa * fSrcX4 + fSina * fSrcY4;
	fDstY4 = -fSina * fSrcX4 + fCosa * fSrcY4;
	
	// ???????????????????
	lNewWidth  = (LONG) ( max( fabs(fDstX4 - fDstX1), fabs(fDstX3 - fDstX2) ) + 0.5);
	
	
	// ?????????????lNewWidth'????????4???????
	LONG	lNewLineBytes=WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) ( max( fabs(fDstY4 - fDstY1), fabs(fDstY3 - fDstY2) )  + 0.5);
	
	// ???????????????????????ζ???????
	f11 = (float) (-0.5 * (lNewWidth - 1) * fCosa - 0.5 * (lNewHeight - 1) * fSina
		+ 0.5 * (lWidth  - 1));
	f22 = (float) ( 0.5 * (lNewWidth - 1) * fSina - 0.5 * (lNewHeight - 1) * fCosa
		+ 0.5 * (lHeight - 1));
		
/*******************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (char * )::GlobalLock((HGLOBAL) hDIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits =(LPBYTE) ::FindDIBBits(lpNewDIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	
	// ????DIB????????????
	

		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;


	// ?????????????????(i1, j1), (i2, j1), (i1, j2), (i2, j2)
	LONG	i1, i2;
	LONG	j1, j2;
	
	// ?????????????
	unsigned char	f1, f2, f3, f4;
	
	// ????????м??
	unsigned char	f12, f34;
	
	// ???????????????????????С???????????????
	FLOAT	EXP;

	
	// ???
	EXP = (FLOAT) 0.0001;
	
/****************************/
/*??д:??????????????????????????
       ????ж????????????,????л?????0??255*/

	for(i=0;i<lNewHeight;i++)
	{
		for(j=0;j<lNewWidth;j++)
		{
			lpDst=lpNewDIBBits+lNewLineBytes*(lNewHeight-1-i)+j;
			i0 = -((float) j) * fSina + ((float) i) * fCosa + f22;
			j0 = ((float) j) * fCosa + ((float) i) * fSina + f11;
			//*lpDst = Interpolation(lpDIB, lWidth, lHeight, j0, i0);

			// ?????????????????????
			i1 = (LONG) j0;
			i2 = i1 + 1;
			j1 = (LONG) i0;
			j2 = j1 + 1;

			// ??????????????
			if((j0<0)||(j0>lWidth-1)||(i0<0)||(i0>lHeight-1))
			{
				*lpDst = (unsigned char) 255; // ?????????????Χ?????????255??
			}else
			{
				if (fabs(j0 - lWidth + 1) <= EXP)
				{
					// ??????????????????
					if (fabs(i0 - lHeight + 1) <= EXP)
					{
						// ??????????????????????????????????????????????
						f1 = *((unsigned char *)lpDIBBits + lLineBytes *
						(lHeight - 1 - j1) + i1);
						*lpDst = (unsigned char) f1;
					} else {
					// ???????????????????????????β??????
					f1 = *((unsigned char *)lpDIBBits + lLineBytes *
					(lHeight - 1 - j1) + i1);
					f3 = *((unsigned char *)lpDIBBits + lLineBytes *
					(lHeight - 1 - j1) + i2);

					// ?????????
					*lpDst = (unsigned char) ((unsigned char) (f1 + (i0 -j1) * (f3 - f1)));
				}
			} else if (fabs(i0 - lHeight + 1) <= EXP) {
				// ?????????????±????????????????????β??????
				f1 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j1) + i1);
				f2 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j2) + i1);

				// ?????????
				*lpDst = (unsigned char) ((unsigned char) (f1 + (j0 -i1) * (f2 - f1)));
			} else {
					// ?????????????????
					f1 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j1) + i1);
					f2 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j2) + i1);
					f3 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j1) + i2);
					f4 = *((unsigned char*)lpDIBBits + lLineBytes * (lHeight - 1 - j2) + i2);

					// ???1
					f12 = (unsigned char) (f1 + (j0 - i1) * (f2 -f1));
					// ???2
					f34 = (unsigned char) (f3 + (j0 - i1) * (f4 - f3));
					// ???3
					*lpDst = (unsigned char) ((unsigned char) (f12 + (i0 -j1) * (f34 - f12)));
				}
			}
		}
	}

	return hDIB;
}



 

void CAView::OnENhanSmooth() 
{

BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;


	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);

	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();

	// ?ж?????????
	if (EhanSmooth(lpDIBBits, lWidth, lHeight ))
	{
	
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
			
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();	


}

BOOL CAView::EhanSmooth(LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{
  /* ???:lpDIBBits?????????????????????
            lWidth????????
                lHeight???????
*/
  /**********??????????p??????***************************************/
	
	LPBYTE lpSrc;//???????
	LONG lLineBytes;//????????
	lLineBytes=WIDTHBYTES(lWidth *8);
    long i,j;	// ???????
    int a[9];   //?????????????
    a[0]=1;
    a[1]=1;
	a[2]=1;
    a[3]=1;
	a[4]=1;
    a[5]=1;
	a[6]=1;
    a[7]=1;
	a[8]=1;

  /****************************?????????д??????????*************/
	double *tempt = new double[lHeight*lWidth];
	int *b = new int[9];
	int k;
	double sum,mean;

	for(i=1;i<lHeight-1;i++){
		for(j=1;j<lWidth-1;j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			b[0]=*(lpDIBBits+lLineBytes*(i-1)+j-1);
			b[1]=*(lpDIBBits+lLineBytes*(i-1)+j);
			b[2]=*(lpDIBBits+lLineBytes*(i-1)+j+1);
			b[3]=*(lpDIBBits+lLineBytes*i+j-1);
			b[4]=*(lpDIBBits+lLineBytes*i+j);
			b[5]=*(lpDIBBits+lLineBytes*i+j+1);
			b[6]=*(lpDIBBits+lLineBytes*(i+1)+j-1);
			b[7]=*(lpDIBBits+lLineBytes*(i+1)+j);
			b[8]=*(lpDIBBits+lLineBytes*(i+1)+j+1);
			sum=0;
			mean=0;
			for(k=0;k<9;k++){
				sum=sum+a[k]*b[k];
			}
			mean=sum/9;
			tempt[lWidth*i+j]=mean;
		}
	}
	for(i=1;i<lHeight-1;i++){
		for(j=1;j<lWidth-1;j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			if(tempt[lWidth*i+j]>255){
				*lpSrc=(unsigned char)255;
			}else if(tempt[lWidth*i+j]<0){
				*lpSrc=(unsigned char)0;
			}else{
				*lpSrc=(unsigned char)tempt[lWidth*i+j];
			}
		}
	}
	return TRUE;
}

void CAView::OnMedianFilter() 
{
BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;


	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);

	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();

	// ?ж?????????
	if (MedianFilter(lpDIBBits, lWidth, lHeight ))
	{
	
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
			
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();	

	
}

BOOL CAView::MedianFilter(LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{
  /* ???:lpDIBBits?????????????????????
            lWidth????????
                lHeight???????
*/
  /**********??????????p??????***************************************/
	
	LPBYTE lpSrc;//???????
	LONG lLineBytes;//????????
	lLineBytes=WIDTHBYTES(lWidth *8);
    long i,j;	// ???????
   

  /****************************?????????д??????????*************/
	int *tempt = new int[lWidth*lHeight];
	unsigned char *b = new unsigned char[18];

	for(i = 1; i < lHeight-1; i++){
		for(j = 1; j < lWidth-1; j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			/*
			b[0]=*(lpDIBBits+lLineBytes*(i-1)+j-1);
			b[1]=*(lpDIBBits+lLineBytes*(i-1)+j);
			b[2]=*(lpDIBBits+lLineBytes*(i-1)+j+1);
			b[3]=*(lpDIBBits+lLineBytes*i+j-1);
			b[4]=*(lpDIBBits+lLineBytes*i+j);
			b[5]=*(lpDIBBits+lLineBytes*i+j+1);
			b[6]=*(lpDIBBits+lLineBytes*(i+1)+j-1);
			b[7]=*(lpDIBBits+lLineBytes*(i+1)+j);
			b[8]=*(lpDIBBits+lLineBytes*(i+1)+j+1);
			*/
			/*
			b[0]=*(lpDIBBits+lLineBytes*(i)+j-4);
			b[1]=*(lpDIBBits+lLineBytes*(i)+j-3);
			b[2]=*(lpDIBBits+lLineBytes*(i)+j-2);
			b[3]=*(lpDIBBits+lLineBytes*(i)+j-1);
			b[4]=*(lpDIBBits+lLineBytes*i+j);
			b[5]=*(lpDIBBits+lLineBytes*(i)+j+1);
			b[6]=*(lpDIBBits+lLineBytes*(i)+j+2);
			b[7]=*(lpDIBBits+lLineBytes*(i)+j+3);
			b[8]=*(lpDIBBits+lLineBytes*(i)+j+4);
			*/

			
			b[0]=*(lpDIBBits+lLineBytes*(i+4)+j-4);
			b[2]=*(lpDIBBits+lLineBytes*(i+3)+j-3);
			b[3]=*(lpDIBBits+lLineBytes*(i+2)+j-2);
			b[4]=*(lpDIBBits+lLineBytes*(i+1)+j-1);
			b[5]=*(lpDIBBits+lLineBytes*(i+4)+j+4);
			b[6]=*(lpDIBBits+lLineBytes*(i+3)+j+3);
			b[7]=*(lpDIBBits+lLineBytes*(i+2)+j+2);
			b[8]=*(lpDIBBits+lLineBytes*(i+1)+j+1);
			b[9]=*(lpDIBBits+lLineBytes*i+j);
			b[10]=*(lpDIBBits+lLineBytes*(i-1)+j-1);
			b[11]=*(lpDIBBits+lLineBytes*(i-2)+j-2);
			b[12]=*(lpDIBBits+lLineBytes*(i-3)+j-3);
			b[13]=*(lpDIBBits+lLineBytes*(i-4)+j-4);
			b[14]=*(lpDIBBits+lLineBytes*(i-1)+j+1);
			b[15]=*(lpDIBBits+lLineBytes*(i-2)+j+2);
			b[16]=*(lpDIBBits+lLineBytes*(i-3)+j+3);
			b[17]=*(lpDIBBits+lLineBytes*(i-4)+j+4);
			
			/*
			b[0]=*(lpDIBBits+lLineBytes*(i)+j-4);
			b[2]=*(lpDIBBits+lLineBytes*(i)+j-3);
			b[3]=*(lpDIBBits+lLineBytes*(i)+j-2);
			b[4]=*(lpDIBBits+lLineBytes*(i)+j-1);
			b[5]=*(lpDIBBits+lLineBytes*(i)+j+4);
			b[6]=*(lpDIBBits+lLineBytes*(i)+j+3);
			b[7]=*(lpDIBBits+lLineBytes*(i)+j+2);
			b[8]=*(lpDIBBits+lLineBytes*(i)+j+1);
			b[9]=*(lpDIBBits+lLineBytes*i+j);
			b[10]=*(lpDIBBits+lLineBytes*(i-1)+j);
			b[11]=*(lpDIBBits+lLineBytes*(i-2)+j);
			b[12]=*(lpDIBBits+lLineBytes*(i-3)+j);
			b[13]=*(lpDIBBits+lLineBytes*(i-4)+j);
			b[14]=*(lpDIBBits+lLineBytes*(i+1)+j);
			b[15]=*(lpDIBBits+lLineBytes*(i+2)+j);
			b[16]=*(lpDIBBits+lLineBytes*(i+3)+j);
			b[17]=*(lpDIBBits+lLineBytes*(i+4)+j);
			*/
			tempt[lWidth*i+j]=GetMedianNum(b,18);
		}
	}

	for(i=1;i<lHeight-1;i++){
		for(j=1;j<lWidth-1;j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			if(tempt[lWidth*i+j]>255){
				*lpSrc=(unsigned char)255;
			}else if(tempt[lWidth*i+j]<0){
				*lpSrc=(unsigned char)0;
			}else{
				*lpSrc=(unsigned char)tempt[lWidth*i+j];
			}
		}
	}
	
	return TRUE;


}


unsigned char CAView::GetMedianNum(unsigned char *b, int num)
{
//?????(e???)
     // ???????
	int		i;
	int		j;
	for(i=0;i<num;i++){
		int k = i;
		for(j=i+1;j<num;j++){
			if(b[j]<b[k]){
				k=j;
			}
		}
		if(k!=i){
			unsigned char temp = b[k];
			b[k] = b[i];
			b[i]=temp;
		}
	}
	// ?м????
	unsigned char f;
	if(num%2==1){
		f = b[num/2];
	}else{
		int t1 = num/2;
		f = (b[t1+1]+b[t1])/2;
	}
	
	return f;
}

void CAView::OnEnhaLsharp() 
{
BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;


	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB??????????λ??
	lpDIBBits = (LPBYTE)::FindDIBBits(lpDIB);

	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();

	// ?ж????????
	if (LSharp(lpDIBBits, lWidth, lHeight ))
	{
	
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
			
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();	

		
}

BOOL CAView::LSharp(LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{
 /* ???:lpDIBBits?????????????????????
            lWidth????????
                lHeight???????
*/
  /**********??????????p??????***************************************/
	
	LPBYTE lpSrc;//???????
	LONG lLineBytes;//????????
	lLineBytes=WIDTHBYTES(lWidth *8);
    long i,j;	// ???????
    int a[9];   //????????????
    a[0]=0;
    a[1]=-1;
	a[2]=0;
    a[3]=-1;
	a[4]=5;
    a[5]=-1;
	a[6]=0;
    a[7]=-1;
	a[8]=0; 

  /****************************?????????д?????????*************/
	double *tempt = new double[lHeight*lWidth];
	int *b = new int[9];
	int k;
	double sum;

	for(i=1;i<lHeight-1;i++){
		for(j=1;j<lWidth-1;j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			b[0]=*(lpDIBBits+lLineBytes*(i-1)+j-1);
			b[1]=*(lpDIBBits+lLineBytes*(i-1)+j);
			b[2]=*(lpDIBBits+lLineBytes*(i-1)+j+1);
			b[3]=*(lpDIBBits+lLineBytes*i+j-1);
			b[4]=*(lpDIBBits+lLineBytes*i+j);
			b[5]=*(lpDIBBits+lLineBytes*i+j+1);
			b[6]=*(lpDIBBits+lLineBytes*(i+1)+j-1);
			b[7]=*(lpDIBBits+lLineBytes*(i+1)+j);
			b[8]=*(lpDIBBits+lLineBytes*(i+1)+j+1);
			sum=0;
			for(k=0;k<9;k++){
				sum=sum+a[k]*b[k];
			}
			tempt[lWidth*i+j]=sum;
		}
	}
	for(i=1;i<lHeight-1;i++){
		for(j=1;j<lWidth-1;j++){
			lpSrc=lpDIBBits+lLineBytes*i+j;
			if(tempt[lWidth*i+j]>255){
				*lpSrc=(unsigned char)255;
			}else if(tempt[lWidth*i+j]<0){
				*lpSrc=(unsigned char)0;
			}else{
				*lpSrc=(unsigned char)tempt[lWidth*i+j];
			}
		}
	}
	return TRUE;
}

void CAView::OnMorphErosion() 
{

	//???????
BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR	lpDIB;

	// ???DIB???????
	LPSTR   lpDIBBits;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	

	// ?????????
	BeginWaitCursor();

	// ???DIB??????????λ??
	lpDIBBits = ::FindDIBBits(lpDIB);
	
   // ??????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB);/*?????????*/


	// ????ErosionDIB()???????DIB

	if (ErosionDIB(lpDIBBits,lWidth ,lHeight))
	{
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);

		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();
	
}
BOOL CAView::ErosionDIB(LPSTR lpDIBBits, LONG lWidth, LONG lHeight)
{
	/********************

  // DIB??????????λ??	
	LPSTR   lpDIBBits;
	
    // ??????????
	LONG	lWidth;
	LONG	lHeight;
		
  *************************/



	// ???????????
	LPSTR	lpSrc;
	
	// ????????????
	LPSTR	lpDst;
	
	// ?????DIB???????
	LPSTR	lpNewDIBBits;
	HLOCAL	hNewDIBBits;

	//???????
	long i;
	long j;
	int  n;


	//?????
	unsigned char pixel;

	// ???????????????????
	hNewDIBBits = LocalAlloc(LHND, lWidth * lHeight);

	if (hNewDIBBits == NULL)
	{
		// ??????????
		return FALSE;
	}
	
	// ???????
	lpNewDIBBits = (char * )LocalLock(hNewDIBBits);

	// ??????・????????????255
	lpDst = (char *)lpNewDIBBits;
	memset(lpDst, (BYTE)255, lWidth * lHeight);
///////////////////////////////////////////////////
 /****************************?????????д????????(????????????????и??)*************/	

	for(j=1;j<lHeight-1;j++){
		for(i=1;i<lWidth-1;i++){
			lpSrc=lpDIBBits+lWidth*j+i;
			lpDst=lpNewDIBBits+lWidth*j+i;
			*lpDst=(unsigned char)255;
			int	flag=0;

			for(int m=0;m<3;m++){
				for(int n=0;n<3;n++){
					pixel=*(lpSrc+(m-1)*lWidth+n-1);
					if(pixel==0){
						*lpDst=(unsigned char)0;
						flag=1;
					}
				}
				if(flag==1){
					break;
				}
			}
		}
	}

		
	// ????????????
	memcpy(lpDIBBits, lpNewDIBBits, lWidth * lHeight);

	// ??????
	LocalUnlock(hNewDIBBits);
	LocalFree(hNewDIBBits);

	// ????
	return TRUE;
}


void CAView::OnMorphDilation() 
{
	//????????
BackForUndo(GetDocument()->GetHDIB());
	// ??????
	CADoc* pDoc = GetDocument();
	
	// ???DIB?????
	LPSTR	lpDIB;

	// ???DIB???????
	LPSTR   lpDIBBits;
	
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
	// ?????????
	BeginWaitCursor();

	// ???DIB??????????λ??
	lpDIBBits = ::FindDIBBits(lpDIB);

	// ??????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB);/*?????????*/

	// ????DilationDIB()????????DIB
	if (DilationDIB(lpDIBBits, lWidth,lHeight ))
	{
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);

		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();
			
}
BOOL CAView::DilationDIB(LPSTR lpDIBBits, LONG lWidth, LONG lHeight)
{
	/********************

  // DIB??????????λ??	
	LPSTR   lpDIBBits;
	
    // ??????????
	LONG	lWidth;
	LONG	lHeight;
		
  *************************/

	// ???????????
	LPSTR	lpSrc;
	
	// ????????????
	LPSTR	lpDst;
	
	// ?????DIB???????
	LPSTR	lpNewDIBBits;
	HLOCAL	hNewDIBBits;

	//???????
	long i;
	long j;
	int  n;

	//?????
	unsigned char pixel;

	// ???????????????????
	hNewDIBBits = LocalAlloc(LHND, lWidth * lHeight);

	if (hNewDIBBits == NULL)
	{
		// ??????????
		return FALSE;
	}
	
	// ???????
	lpNewDIBBits = (char * )LocalLock(hNewDIBBits);

	// ??????・????????????255
	lpDst = (char *)lpNewDIBBits;
	memset(lpDst, (BYTE)255, lWidth * lHeight);

//////////////////////////////
 /****************************?????????д??????????(?????????????????????)*************/
	
	for(j=1;j<lHeight-1;j++){
		for(i=1;i<lWidth-1;i++){
			lpSrc=lpDIBBits+lWidth*j+i;
			lpDst=lpNewDIBBits+lWidth*j+i;
			*lpDst=(unsigned char)0;
			int	flag=0;

			for(int m=0;m<4;m++){
				for(int n=0;n<4;n++){
					pixel=*(lpSrc+(m-1)*lWidth+n-1);
					if(pixel==255){
						*lpDst=(unsigned char)255;
						flag=1;
					}
				}
				if(flag==1){
						break;
					}
			}
		}
	}

	// ?????????????
	memcpy(lpDIBBits, lpNewDIBBits, lWidth * lHeight);

	// ??????
	LocalUnlock(hNewDIBBits);
	LocalFree(hNewDIBBits);

	// ????
	return TRUE;

}






void CAView::Onliantong() 
{

	BackForUndo(GetDocument()->GetHDIB());


	// ??????
	CADoc* pDoc = GetDocument();

	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
    // ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;
	
	// ????DIB??????????λ??
	lpDIBBits =( LPBYTE)::FindDIBBits(lpDIB);

	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ????ZoomDIB()???????DIB
	hNewDIB = (HDIB)LianTong (lpDIB,lpDIBBits, lWidth, lHeight );
	
	// ?ж??????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
	
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();

}




HGLOBAL CAView::LianTong(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{

	// ????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
	LONG	lTempWidth;
	LONG	lTempHeight;
	LONG	lTemp2Width;
	LONG	lTemp2Height;
		
	// ???????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	LPSTR	lpTempDIB;
	LPBYTE	lpTempDIBBits;
	LPSTR	lpTemp2DIB;
	LPBYTE	lpTemp2DIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;
	LPBITMAPINFOHEADER lpbmiT;
	LPBITMAPINFOHEADER lpbmiT2;
    // ??DIB???
	HDIB	hDIB;
	HDIB	tempDIB;
	HDIB	temp2DIB;

	// ???????
	LONG	lNewLineBytes;
	LONG	lTempLineBytes;
	LONG	lTemp2LineBytes;
/***************************/

/** ??д: ???????  **/

	// ????????????????????
	LPBYTE	lpDst, lpSrc, lpTmp, lpTmp2;
	
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	
	// ?????е??????
	LONG lLineBytes;
	
		// ?????????е??????
	lLineBytes = WIDTHBYTES(lWidth * 8);
	
	
	// ???????????????????
		lNewWidth = (LONG) (lWidth);
		lTempWidth = (LONG) (lWidth);
		lTemp2Width = (LONG) (lWidth);
	
	// ???????????е??????
	lNewLineBytes = WIDTHBYTES(lNewWidth * 8);
	lTempLineBytes = WIDTHBYTES(lNewWidth * 8);
	lTemp2LineBytes = WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) (lHeight);
	lTempHeight = (LONG) (lHeight);
	lTemp2Height = (LONG) (lHeight);
	

/****************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	tempDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	temp2DIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL || tempDIB == NULL || temp2DIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (char * )::GlobalLock((HGLOBAL) hDIB);
	lpTempDIB =  (char * )::GlobalLock((HGLOBAL) tempDIB);
	lpTemp2DIB =  (char * )::GlobalLock((HGLOBAL) temp2DIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	memcpy(lpTempDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	memcpy(lpTemp2DIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits =(LPBYTE) ::FindDIBBits(lpNewDIB);
	lpTempDIBBits =(LPBYTE) ::FindDIBBits(lpTempDIB);
	lpTemp2DIBBits =(LPBYTE) ::FindDIBBits(lpTemp2DIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	lpbmiT = (LPBITMAPINFOHEADER)lpTempDIB;
	lpbmiT2 = (LPBITMAPINFOHEADER)lpTemp2DIB;
	
	// ????DIB????????????
	
		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;
		lpbmiT->biWidth = lNewWidth;
		lpbmiT->biHeight = lNewHeight;
		lpbmiT2->biWidth = lNewWidth;
		lpbmiT2->biHeight = lNewHeight;

	


/////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

	int tmp = 0;
	//????????????255
	for(i = 0; i < lNewHeight; i++){
		for(j = 0; j < lNewWidth; j++) {
			lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -i) +j;
			lpTmp2 = lpTemp2DIBBits + lTemp2LineBytes * (lTemp2Height - 1 -i) +j;
			lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -i) +j;
			*lpTmp = (unsigned char) 255;
			*lpTmp2 = (unsigned char) 255;
			*lpDst = (unsigned char) 255;
		}
	}

	for(i = 0; i < lNewHeight; i++){
		for(j = 0; j < lNewWidth; j++) {
			lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -i) +j;
			lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -i) +j;
			if(*lpSrc == (unsigned char) 0) {
				//??????????????????????
				*lpTmp = (unsigned char) 0;
				for(int k=0; k < 110; k++) {
					// ????????????
					int c, d;
					for(c = 1; c < lNewHeight-1; c++){
						for(int b = 1; b < lNewWidth-1; b++) {
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							lpTmp2 = lpTemp2DIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							for(int g = 0; g < 3; g++){
								int flag = 0;
								for(int h = 0; h < 3; h++){
									unsigned char pp = *(lpTmp + lTempLineBytes * (g-1) +h-1);
									if(pp == (unsigned char) 0){
										*lpTmp2 = (unsigned char) 0;
										flag = 1;
										break;
									}
								}
								if(flag == 1){
									break;
								}
							}
						}
					}
					for(c = 0; c < lNewHeight; c++){
						for(int b = 0; b < lNewWidth; b++) {
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							lpTmp2 = lpTemp2DIBBits + lTemp2LineBytes * (lTemp2Height - 1 -c) +b;
							*lpTmp = *lpTmp2;
						}
					}
					
					//?????????
					for( c=1;c<lHeight;c++){
						for( d=1;d<lWidth;d++){
							lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -c) +d;
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +d;
							if(!(*lpSrc == (unsigned char)0)){
								*lpTmp = (unsigned char) 255;
							}
						}
					}
				}
				//????????
				for(int c=1;c<lHeight;c++){
					for(int d=1;d<lWidth;d++){
						lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -c) +d;
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +d;
						if(*lpTmp == (unsigned char)0){
							*lpSrc = (unsigned char) 255;
						}
					}
				}
				//tmp?????????
				tmp = tmp + 63;
				for(int a=1;a<lHeight-1;a++){
					for(int b=1;b<lWidth-1;b++){
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -a) +b;
						if(*lpTmp == (unsigned char)0){
							*lpDst = (unsigned char) tmp;
						}
					}
				}
				//???tmp
				for(c = 0; c < lNewHeight; c++){
					for(int b = 0; b < lNewWidth; b++) {
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
						*lpTmp = (unsigned char) 255;
					}
				}
			}
		}
	}
	
/****************************/
	return hDIB;

}

void CAView::OnLianTongPhone() 
{
	// TODO: Add your command handler code here
	
	BackForUndo(GetDocument()->GetHDIB());


	// ??????
	CADoc* pDoc = GetDocument();

	
	// ???DIB?????
	LPSTR lpDIB;
	
	// ???DIB????????
	LPBYTE lpDIBBits;
	// ????DIB
	lpDIB = (LPSTR) ::GlobalLock((HGLOBAL) pDoc->GetHDIB());
	
    // ???????????
	LONG	lWidth;
	LONG	lHeight;
		
	lWidth=::DIBWidth(lpDIB);/* ???????"????"??4???????*/
	lHeight=::DIBHeight(lpDIB)/*?????????*/;
	
	// ????DIB??????????λ??
	lpDIBBits =( LPBYTE)::FindDIBBits(lpDIB);

	// ??????DIB
	HDIB hNewDIB = NULL;
	
	// ?????????
	BeginWaitCursor();
	
	// ????ZoomDIB()???????DIB
	hNewDIB = (HDIB)LianTongPhone (lpDIB,lpDIBBits, lWidth, lHeight );
	
	// ?ж??????????
	if (hNewDIB != NULL)
	{
		
		// ?IDIB????????DIB????
		pDoc->ReplaceHDIB(hNewDIB);

		// ????DIB??С??????
		pDoc->InitDIBData();
		
		// ????????
		pDoc->SetModifiedFlag(TRUE);
		
	
		// ???????
		pDoc->UpdateAllViews(NULL);
	}
	else
	{
		// ??????
		MessageBox("???????????");
	}
	
	// ???????
	::GlobalUnlock((HGLOBAL) pDoc->GetHDIB());

	// ??????
	EndWaitCursor();
	
}


HGLOBAL CAView::LianTongPhone(LPSTR lpDIB, LPBYTE lpDIBBits, LONG lWidth, LONG lHeight)
{

	// ????????????
	LONG	lNewWidth;
	LONG	lNewHeight;
	LONG	lTempWidth;
	LONG	lTempHeight;
	LONG	lTemp2Width;
	LONG	lTemp2Height;
		
	// ???????
	LPSTR	lpNewDIB;
	LPBYTE	lpNewDIBBits;
	LPSTR	lpTempDIB;
	LPBYTE	lpTempDIBBits;
	LPSTR	lpTemp2DIB;
	LPBYTE	lpTemp2DIBBits;
	// ???BITMAPINFO???????
	LPBITMAPINFOHEADER lpbmi;
	LPBITMAPINFOHEADER lpbmiT;
	LPBITMAPINFOHEADER lpbmiT2;
    // ??DIB???
	HDIB	hDIB;
	HDIB	tempDIB;
	HDIB	temp2DIB;

	// ???????
	LONG	lNewLineBytes;
	LONG	lTempLineBytes;
	LONG	lTemp2LineBytes;
/***************************/

/** ??д: ???????  **/

	// ????????????????????
	LPBYTE	lpDst, lpSrc, lpTmp, lpTmp2;
	
	// ?????????????????DIB?е?????
	LONG	i;
	LONG	j;
	
	
	// ?????е??????
	LONG lLineBytes;
	
		// ?????????е??????
	lLineBytes = WIDTHBYTES(lWidth * 8);
	
	
	// ???????????????????
		lNewWidth = (LONG) (lWidth);
		lTempWidth = (LONG) (lWidth);
		lTemp2Width = (LONG) (lWidth);
	
	// ???????????е??????
	lNewLineBytes = WIDTHBYTES(lNewWidth * 8);
	lTempLineBytes = WIDTHBYTES(lNewWidth * 8);
	lTemp2LineBytes = WIDTHBYTES(lNewWidth * 8);
	
	// ???????????????
	lNewHeight = (LONG) (lHeight);
	lTempHeight = (LONG) (lHeight);
	lTemp2Height = (LONG) (lHeight);
	

/****************************/

	// ?????????????DIB
	hDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	tempDIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	temp2DIB = (HDIB) ::GlobalAlloc(GHND, lNewLineBytes * lNewHeight + *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?ж?????????????
	if (hDIB == NULL || tempDIB == NULL || temp2DIB == NULL)
	{
		// ??????????
		return NULL;
	}

	// ???????
	lpNewDIB =  (char * )::GlobalLock((HGLOBAL) hDIB);
	lpTempDIB =  (char * )::GlobalLock((HGLOBAL) tempDIB);
	lpTemp2DIB =  (char * )::GlobalLock((HGLOBAL) temp2DIB);
	
	// ????DIB??????????
	memcpy(lpNewDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	memcpy(lpTempDIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	memcpy(lpTemp2DIB, lpDIB, *(LPDWORD)lpDIB + ::PaletteSize(lpDIB));
	
	// ?????DIB???????λ??
	lpNewDIBBits =(LPBYTE) ::FindDIBBits(lpNewDIB);
	lpTempDIBBits =(LPBYTE) ::FindDIBBits(lpTempDIB);
	lpTemp2DIBBits =(LPBYTE) ::FindDIBBits(lpTemp2DIB);
	
	// ??????
	lpbmi = (LPBITMAPINFOHEADER)lpNewDIB;
	lpbmiT = (LPBITMAPINFOHEADER)lpTempDIB;
	lpbmiT2 = (LPBITMAPINFOHEADER)lpTemp2DIB;
	
	// ????DIB????????????
	
		lpbmi->biWidth = lNewWidth;
		lpbmi->biHeight = lNewHeight;
		lpbmiT->biWidth = lNewWidth;
		lpbmiT->biHeight = lNewHeight;
		lpbmiT2->biWidth = lNewWidth;
		lpbmiT2->biHeight = lNewHeight;

	


/////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

	//将临时表清空
	for(i = 0; i < lNewHeight; i++){
		for(j = 0; j < lNewWidth; j++) {
			lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -i) +j;
			lpTmp2 = lpTemp2DIBBits + lTemp2LineBytes * (lTemp2Height - 1 -i) +j;
			lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -i) +j;
			*lpTmp = (unsigned char) 255;
			*lpTmp2 = (unsigned char) 255;
			*lpDst = (unsigned char) 255;
		}
	}

	//存放识别的数字
	int arr[11];
	int cur = 0;

	for(i = 0; i < lNewHeight; i++){
		for(j = 0; j < lNewWidth; j++) {
			lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -i) +j;
			lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -i) +j;
			if(*lpSrc == (unsigned char) 0) {
				
				*lpTmp = (unsigned char) 0;
				int minI = lNewHeight;
				int maxI = -1;
				int minJ = lNewWidth;
				int maxJ = -1;

				//循环膨胀和取交集
				for(int k=0; k < 110; k++) {
					// 膨胀
					int c, d;
					for(c = 1; c < lNewHeight-1; c++){
						for(int b = 1; b < lNewWidth-1; b++) {
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							lpTmp2 = lpTemp2DIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							for(int g = 0; g < 3; g++){
								int flag = 0;
								for(int h = 0; h < 3; h++){
									unsigned char pp = *(lpTmp + lTempLineBytes * (g-1) +h-1);
									if(pp == (unsigned char) 0){
										*lpTmp2 = (unsigned char) 0;
										flag = 1;
										if(minI > c){minI = c;}
										if(maxI < c){maxI = c;}
										if(minJ > b){minJ = b;}
										if(maxJ < b){maxJ = b;}
										break;
									}
								}
								if(flag == 1){
									break;
								}
							}
						}
					}
					for(c = 0; c < lNewHeight; c++){
						for(int b = 0; b < lNewWidth; b++) {
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
							lpTmp2 = lpTemp2DIBBits + lTemp2LineBytes * (lTemp2Height - 1 -c) +b;
							*lpTmp = *lpTmp2;
						}
					}
					
					//tmp与原图取交集
					for( c=1;c<lHeight;c++){
						for( d=1;d<lWidth;d++){
							lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -c) +d;
							lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +d;
							if(!(*lpSrc == (unsigned char)0)){
								*lpTmp = (unsigned char) 255;
							}
						}
					}
				}
				//清除全图已连通的图案
				for(int c=1;c<lHeight;c++){
					for(int d=1;d<lWidth;d++){
						lpSrc = lpDIBBits + lLineBytes * (lHeight - 1 -c) +d;
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +d;
						if(*lpTmp == (unsigned char)0){
							
							*lpSrc = (unsigned char) 255;
						}
					}
				}
				
				//tmp复制到结果图
				for(int a=1;a<lHeight-1;a++){
					for(int b=1;b<lWidth-1;b++){
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -a) +b;
						if(*lpTmp == (unsigned char)0){
							*lpDst = (unsigned char) 0;
						}
					}
				}
				
				
				//画出左右竖线
				for(a=minI-3;a<maxI+3;a++){
					int b = minJ-3;
					lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
					*lpDst = (unsigned char) 0;
					b = maxJ+3;
					lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
					*lpDst = (unsigned char) 0;
				}
				//画出上下横线
				for(a=minJ-3;a<maxJ+3;a++){
					int b = minI-3;
					lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -b) +a;
					*lpDst = (unsigned char) 0;
					b = maxI+3;
					lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -b) +a;
					*lpDst = (unsigned char) 0;
				}

				//识别数字
				double t[4] = {0,0,0,0};
				int all = 0;
				int midI=(maxI+minI)/2;
				int midJ=(maxJ+minJ)/2;
				//左上角
				for(a=minI;a<midI;a++){
					for(int b = minJ; b < midJ; b++){
						all++;
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						if(*lpDst == (unsigned char) 0){
							t[0] += 1;
						}
					}
				}
				t[0] /= all;


				//右上角
				all = 0;
				for(a=minI;a<midI;a++){
					for(int b = midJ; b < maxJ; b++){
						all++;
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						if(*lpDst == (unsigned char) 0){
							t[1] += 1;
						}
					}
				}
				t[1] /= all;

				//左下角
				all = 0;
				for(a=midI;a<maxI;a++){
					for(int b = minJ; b < midJ; b++){
						all++;
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						if(*lpDst == (unsigned char) 0){
							t[2] += 1;
						}
					}
				}
				t[2] /= all;

				//右下角
				all = 0;
				for(a=midI;a<maxI;a++){
					for(int b = midJ; b < maxJ; b++){
						all++;
						lpDst = lpNewDIBBits + lNewLineBytes * (lNewHeight - 1 -a) +b;
						if(*lpDst == (unsigned char) 0){
							t[3] += 1;
						}
					}
				}
				t[3] /= all;

				//arr[cur] = tt;
				double stand[10][4];
				stand[0][0] = 0.428; stand[0][1] = 0.492; stand[0][2] = 0; stand[0][3] = 0.476;
				stand[1][0] = 0.185; stand[1][1] = 0.494; stand[1][2] = 0; stand[1][3] = 0.338;
				stand[2][0] = 0.481; stand[2][1] = 0.406; stand[2][2] = 0.232; stand[2][3] = 0.454;
				stand[3][0] = 0.158; stand[3][1] = 0.192; stand[3][2] = 0.464; stand[3][3] = 0.438;
				stand[4][0] = 0.427; stand[4][1] = 0.227; stand[4][2] = 0.131; stand[4][3] = 0.357;
				stand[5][0] = 0.233; stand[5][1] = 0.336; stand[5][2] = 0.187; stand[5][3] = 0.489;
				stand[6][0] = 0.182; stand[6][1] = 0.331; stand[6][2] = 0.117; stand[6][3] = 0.327;
				stand[7][0] = 0.195; stand[7][1] = 0.195; stand[7][2] = 0.242; stand[7][3] = 0.276;
				stand[8][0] = 0.392; stand[8][1] = 0.904; stand[8][2] = 0.464; stand[8][3] = 0.952;
				stand[9][0] = 0.250; stand[9][1] = 0.333; stand[9][2] = 0.314; stand[9][3] = 0.314;
				
				double tt[10];
				for(int f = 0; f < 10; f++){
					tt[f] = 0;
					double temps = 0;
					for(int h = 0; h < 4; h++){
						temps += stand[f][h] - t[h];
					}
					if(temps < 0) temps = -temps;
					tt[f] = temps;
				}
				arr[cur] = 0;
				double min = tt[0];
				for(f = 1; f < 10; f++){
					if(min > tt[f]){
						min = tt[f];
						arr[cur] = f;
					}
				}
				cur++;
				//清空tmp
				for(c = 0; c < lNewHeight; c++){
					for(int b = 0; b < lNewWidth; b++) {
						lpTmp = lpTempDIBBits + lTempLineBytes * (lTempHeight - 1 -c) +b;
						*lpTmp = (unsigned char) 255;
					}
				}
			}
		}
	}
	
		
	CString res = "";
	for(int f = 0; f < 11; f++){
		CString str;
		str.Format(_T("%d"), arr[f]);
		res += str + "  ";
	}
	MessageBox(res);
/****************************/
	return hDIB;

}
